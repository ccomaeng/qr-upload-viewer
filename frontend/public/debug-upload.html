<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>업로드 디버그 테스트</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffebee; border-left: 4px solid #f44336; }
        .success { background: #e8f5e8; border-left: 4px solid #4caf50; }
        .info { background: #e3f2fd; border-left: 4px solid #2196f3; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        input[type="file"] { margin: 10px 0; }
    </style>
</head>
<body>
    <h1>QR Upload Viewer - 업로드 디버그</h1>
    
    <div>
        <h2>1. 백엔드 연결 테스트</h2>
        <button onclick="testBackendConnection()">백엔드 연결 확인</button>
        <div id="connection-result"></div>
    </div>

    <div>
        <h2>2. 업로드 테스트</h2>
        <input type="file" id="file-input" accept="image/*">
        <button onclick="testUpload()">업로드 테스트</button>
        <div id="upload-result"></div>
    </div>

    <div>
        <h2>3. QR 생성 테스트</h2>
        <input type="text" id="upload-id" placeholder="업로드 ID 입력">
        <button onclick="testQRGeneration()">QR 생성 테스트</button>
        <div id="qr-result"></div>
    </div>

    <div>
        <h2>로그</h2>
        <div id="log-container"></div>
    </div>

    <script>
        const API_BASE_URL = 'https://qr-upload-viewer-backend.onrender.com';
        
        function log(message, type = 'info') {
            const logContainer = document.getElementById('log-container');
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            logContainer.insertBefore(logDiv, logContainer.firstChild);
            console.log(message);
        }

        async function testBackendConnection() {
            const resultDiv = document.getElementById('connection-result');
            resultDiv.innerHTML = '테스트 중...';
            
            try {
                log('백엔드 연결 테스트 시작...', 'info');
                
                const response = await fetch(`${API_BASE_URL}/health`);
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `✅ 연결 성공: ${JSON.stringify(data, null, 2)}`;
                    log('백엔드 연결 성공', 'success');
                } else {
                    resultDiv.innerHTML = `❌ 연결 실패: ${response.status}`;
                    log(`백엔드 연결 실패: ${response.status}`, 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `❌ 오류: ${error.message}`;
                log(`백엔드 연결 오류: ${error.message}`, 'error');
            }
        }

        async function testUpload() {
            const fileInput = document.getElementById('file-input');
            const resultDiv = document.getElementById('upload-result');
            
            if (!fileInput.files[0]) {
                alert('파일을 선택해주세요');
                return;
            }
            
            const file = fileInput.files[0];
            resultDiv.innerHTML = '업로드 중...';
            
            try {
                log(`업로드 시작: ${file.name} (${file.size} bytes)`, 'info');
                
                const formData = new FormData();
                formData.append('image', file);
                
                const response = await fetch(`${API_BASE_URL}/api/upload`, {
                    method: 'POST',
                    body: formData,
                    mode: 'cors'
                });
                
                log(`업로드 응답 상태: ${response.status}`, 'info');
                
                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML = `✅ 업로드 성공: <pre>${JSON.stringify(data, null, 2)}</pre>`;
                    log('업로드 성공', 'success');
                    
                    // 업로드 ID를 QR 테스트 필드에 자동 입력
                    if (data.uploadId) {
                        document.getElementById('upload-id').value = data.uploadId;
                    }
                } else {
                    const errorText = await response.text();
                    resultDiv.innerHTML = `❌ 업로드 실패: ${response.status} - ${errorText}`;
                    log(`업로드 실패: ${response.status} - ${errorText}`, 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `❌ 오류: ${error.message}`;
                log(`업로드 오류: ${error.message}`, 'error');
            }
        }

        async function testQRGeneration() {
            const uploadId = document.getElementById('upload-id').value;
            const resultDiv = document.getElementById('qr-result');
            
            if (!uploadId) {
                alert('업로드 ID를 입력해주세요');
                return;
            }
            
            resultDiv.innerHTML = 'QR 생성 중...';
            
            try {
                log(`QR 생성 시작: ${uploadId}`, 'info');
                
                const response = await fetch(`${API_BASE_URL}/api/generate-qr/${uploadId}`, {
                    method: 'POST',
                    mode: 'cors'
                });
                
                log(`QR 생성 응답 상태: ${response.status}`, 'info');
                
                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML = `✅ QR 생성 성공: <pre>${JSON.stringify(data, null, 2)}</pre>`;
                    
                    if (data.qrImageUrl) {
                        resultDiv.innerHTML += `<br><img src="${API_BASE_URL}${data.qrImageUrl}" alt="QR Code" style="max-width: 200px;">`;
                    }
                    
                    log('QR 생성 성공', 'success');
                } else {
                    const errorText = await response.text();
                    resultDiv.innerHTML = `❌ QR 생성 실패: ${response.status} - ${errorText}`;
                    log(`QR 생성 실패: ${response.status} - ${errorText}`, 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `❌ 오류: ${error.message}`;
                log(`QR 생성 오류: ${error.message}`, 'error');
            }
        }

        // 페이지 로드시 자동으로 백엔드 연결 테스트
        window.addEventListener('load', testBackendConnection);
    </script>
</body>
</html>